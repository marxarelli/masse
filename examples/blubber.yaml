# Example definition file for Blubber's buildkit frontend
parameters:
  REPO_REMOTE: "https://gitlab.wikimedia.org/repos/releng/blubber"
  REPO_REF: refs/heads/main

options:
  go-build-env:
    - env:
        CGO_ENABLED: "0"
    - cache: /root/.cache/go-build

macros:
  apt::packages:
    - assert:
        $packages: []
        $options: []
        where: "packages.all(p, p.matches(debianPackage))"
      invalid: ""
      =>: !cel |
        [
          Run {
            command: "apt-get update && apt-get install --no-recommends -y",
            args: packages,
            options: [
              env({

              }),
              Cache {
                path: "/var/cache/apt",
                access: Cache.LOCKED,
              },
            ] + runOptions(options),
          },
        ]

targets:
  repo:
    - git:
        remote: $REPO_REMOTE
        ref: $REPO_REF

  go:
    - image: docker-registry.wikimedia.org/golang1.19:1.19-1-20230730

  build-tools:
    - merge: [go]
    - diff:
        - apt::packages: [gcc, git, make]

  modules:
    - merge: [go]
    - link: [go.mod, go.sum]
      from: repo
    - diff:
        - run: go mod download

  frontend-binaries:
    - merge: [go, build-tools, modules]
    - link: [.]
      from: repo
    - run: make clean blubber-buildkit
      options:
        - cache: /root/.cache/go-build
          access: locked

  frontend:
    - copy: [/src/blubber-buildkit]
      from: frontend-binaries
      to: [/blubber-buildkit]

images:
  blubber-buildkit:
    comprises:
      - frontend
